---
# Ansible Playbook: Update all Docker containers
# Pulls latest images for all running containers, recreates them
# with the same configuration (ports, volumes, env, etc.)
# Replaces Watchtower with a controlled, scheduled approach.
#
# Required extra-vars (set in Semaphore Environment):
#   gotify_url    - Gotify server URL (e.g. http://gotify/)
#   gotify_token  - Gotify application token

- name: Update all Docker containers
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    gotify_url: "{{ lookup('env', 'GOTIFY_URL') | default(gotify_url, true) }}"
    gotify_token: "{{ lookup('env', 'GOTIFY_TOKEN') | default(gotify_token, true) }}"
    gotify_priority: 5
    prune_old_images: true

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Get list of all running containers
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get all running containers
      ansible.builtin.shell: >
        docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | sort
      register: running_containers
      changed_when: false

    - name: Display running containers
      ansible.builtin.debug:
        msg: "Found {{ running_containers.stdout_lines | length }} running containers: {{ running_containers.stdout_lines | join(', ') }}"

    - name: Skip if no containers running
      ansible.builtin.meta: end_host
      when: running_containers.stdout_lines | length == 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. Get current image digests for comparison
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get current image info per container
      ansible.builtin.shell: >
        docker inspect --format '{{ '{{' }}.Name{{ '}}' }}|{{ '{{' }}.Config.Image{{ '}}' }}|{{ '{{' }}.Image{{ '}}' }}' {{ item }}
      loop: "{{ running_containers.stdout_lines }}"
      register: container_images
      changed_when: false

    - name: Build container image map
      ansible.builtin.set_fact:
        _container_map: >-
          {{ _container_map | default({}) | combine({
            item.stdout.split('|')[0] | regex_replace('^/', ''): {
              'image': item.stdout.split('|')[1],
              'old_digest': item.stdout.split('|')[2]
            }
          }) }}
      loop: "{{ container_images.results }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. Pull latest images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get unique images to pull
      ansible.builtin.set_fact:
        _unique_images: "{{ _container_map.values() | map(attribute='image') | unique | list }}"

    - name: Display images to pull
      ansible.builtin.debug:
        msg: "Pulling {{ _unique_images | length }} unique images: {{ _unique_images | join(', ') }}"

    - name: Pull latest images
      ansible.builtin.shell: "docker pull {{ item }}"
      loop: "{{ _unique_images }}"
      register: pull_results
      changed_when: "'Downloaded newer image' in item_result.stdout | default('') or 'Pull complete' in item_result.stdout | default('')"
      loop_control:
        loop_var: item_result
        label: "{{ item }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. Check which containers need updating
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get new image digests
      ansible.builtin.shell: >
        docker inspect --format '{{ '{{' }}.Id{{ '}}' }}' {{ item.value.image }}
      loop: "{{ _container_map | dict2items }}"
      register: new_digests
      changed_when: false

    - name: Build update list
      ansible.builtin.set_fact:
        _containers_to_update: >-
          {{ _containers_to_update | default([]) +
            ([item.item.key] if item.stdout != _container_map[item.item.key].old_digest else [])
          }}
      loop: "{{ new_digests.results }}"

    - name: Set update list to empty if undefined
      ansible.builtin.set_fact:
        _containers_to_update: "{{ _containers_to_update | default([]) }}"

    - name: Display containers that need updating
      ansible.builtin.debug:
        msg: >-
          {{ _containers_to_update | length }} container(s) need updating:
          {{ _containers_to_update | join(', ') if _containers_to_update | length > 0 else 'None' }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. Recreate containers with new images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get full container run config
      ansible.builtin.shell: |
        docker inspect --format '
        --name {{ item }}
        {{ '{{' }} range .HostConfig.Binds {{ '}}' }}-v {{ '{{' }} . {{ '}}' }} {{ '{{' }} end {{ '}}' }}
        {{ '{{' }} range $k, $v := .HostConfig.PortBindings {{ '}}' }}{{ '{{' }} range $v {{ '}}' }}-p {{ '{{' }} .HostIP {{ '}}' }}:{{ '{{' }} .HostPort {{ '}}' }}:{{ '{{' }} $k {{ '}}' }} {{ '{{' }} end {{ '}}' }}{{ '{{' }} end {{ '}}' }}
        {{ '{{' }} range .Config.Env {{ '}}' }}-e {{ '{{' }} . {{ '}}' }} {{ '{{' }} end {{ '}}' }}
        {{ '{{' }} if .HostConfig.RestartPolicy.Name {{ '}}' }}--restart {{ '{{' }} .HostConfig.RestartPolicy.Name {{ '}}' }}{{ '{{' }} end {{ '}}' }}
        {{ '{{' }} if .HostConfig.NetworkMode {{ '}}' }}--network {{ '{{' }} .HostConfig.NetworkMode {{ '}}' }}{{ '{{' }} end {{ '}}' }}
        {{ '{{' }} if .Config.Hostname {{ '}}' }}--hostname {{ '{{' }} .Config.Hostname {{ '}}' }}{{ '{{' }} end {{ '}}' }}
        {{ '{{' }} if .HostConfig.Privileged {{ '}}' }}--privileged{{ '{{' }} end {{ '}}' }}
        {{ '{{' }} range .HostConfig.Devices {{ '}}' }}--device {{ '{{' }} .PathOnHost {{ '}}' }}:{{ '{{' }} .PathInContainer {{ '}}' }} {{ '{{' }} end {{ '}}' }}
        {{ '{{' }} range .HostConfig.CapAdd {{ '}}' }}--cap-add {{ '{{' }} . {{ '}}' }} {{ '{{' }} end {{ '}}' }}
        {{ '{{' }} if .HostConfig.PidMode {{ '}}' }}--pid {{ '{{' }} .HostConfig.PidMode {{ '}}' }}{{ '{{' }} end {{ '}}' }}
        {{ '{{' }} range $k, $v := .Config.Labels {{ '}}' }}-l {{ '{{' }} $k {{ '}}' }}={{ '{{' }} $v {{ '}}' }} {{ '{{' }} end {{ '}}' }}
        -d {{ '{{' }} .Config.Image {{ '}}' }}
        {{ '{{' }} if .Config.Cmd {{ '}}' }}{{ '{{' }} range .Config.Cmd {{ '}}' }}{{ '{{' }} . {{ '}}' }} {{ '{{' }} end {{ '}}' }}{{ '{{' }} end {{ '}}' }}
        ' {{ item }} | tr -s ' \n' ' '
      loop: "{{ _containers_to_update }}"
      register: container_configs
      changed_when: false
      when: _containers_to_update | length > 0

    - name: Stop and remove old container
      ansible.builtin.shell: |
        docker stop {{ item.item }} && docker rm {{ item.item }}
      loop: "{{ container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: _containers_to_update | length > 0

    - name: Recreate container with new image
      ansible.builtin.shell: |
        docker run {{ item.stdout | trim }}
      loop: "{{ container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      register: recreate_results
      when: _containers_to_update | length > 0

    - name: Verify containers are running
      ansible.builtin.shell: >
        docker ps --filter "name=^{{ item }}$" --format '{{ '{{' }}.Status{{ '}}' }}'
      loop: "{{ _containers_to_update }}"
      register: verify_results
      failed_when: "'Up' not in verify_results.stdout"
      changed_when: false
      when: _containers_to_update | length > 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6. Cleanup old images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Prune dangling images
      ansible.builtin.shell: docker image prune -f
      register: prune_result
      changed_when: "'Total reclaimed space: 0B' not in prune_result.stdout"
      when: prune_old_images

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7. Gotify Notification
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Ensure curl is installed
      ansible.builtin.apt:
        name: curl
        state: present

    - name: Build Gotify notification metadata
      ansible.builtin.set_fact:
        _gotify_title: >-
          {{ 'ðŸ³ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” ' +
             (_containers_to_update | length | string) + ' container(s) updated'
             if _containers_to_update | length > 0
             else 'ðŸ³ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” All containers up to date' }}
        _gotify_priority: "{{ 6 if _containers_to_update | length > 0 else gotify_priority }}"

    - name: Build Gotify message body
      ansible.builtin.set_fact:
        _gotify_message: >-
          ðŸ–¥ï¸ **Host:** {{ ansible_hostname }}\n\nðŸŒ
          **IP:** {{ ansible_default_ipv4.address }}\n\nðŸ³
          **Containers running:** {{ running_containers.stdout_lines | length }}\n\nðŸ“¦
          **Updated:** {{ _containers_to_update | length }}\n\n{{
          'ðŸ”„ **Updated containers:**\n' + _containers_to_update | join(', ') + '\n\n'
          if _containers_to_update | length > 0
          else '' }}---\n\n{{
          'âœ… **All containers recreated and running**'
          if _containers_to_update | length > 0
          else 'âœ… **All images are already latest**' }}

    - name: Send Gotify notification
      ansible.builtin.shell: |
        cat <<'PAYLOAD' | curl -s -m 15 -o /dev/null -w "%{http_code}" \
          -X POST "{{ gotify_url }}message" \
          -H "X-Gotify-Key: {{ gotify_token }}" \
          -H "Content-Type: application/json" \
          -d @-
        {
          "title": "{{ _gotify_title | trim }}",
          "message": "{{ _gotify_message | trim }}",
          "priority": {{ _gotify_priority }},
          "extras": {"client::display": {"contentType": "text/markdown"}}
        }
        PAYLOAD
      register: gotify_response
      changed_when: false
      failed_when: gotify_response.stdout != "200"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8. Final Status
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Display final status
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_hostname }} ({{ inventory_hostname }})"
          - "Total containers: {{ running_containers.stdout_lines | length }}"
          - "Containers updated: {{ _containers_to_update | length }}"
          - "Updated: {{ _containers_to_update | join(', ') if _containers_to_update | length > 0 else 'None' }}"
          - "Images pruned: {{ 'Yes' if prune_result.changed | default(false) else 'No' }}"
